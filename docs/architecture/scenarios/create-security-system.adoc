== Scenario: Create Security System

=== Overview

This scenario describes the distributed transaction for creating a security system for an existing location. The operation spans multiple services and is coordinated by the CreateSecuritySystemSaga orchestrator.

=== Prerequisites

Before creating a security system, a Location must already exist. Locations are created via the Customer Service's `POST /customers/{customerId}/locations` endpoint.

=== Sequence Diagram

[plantuml]
....
@startuml
actor User
participant "BFF" as BFF
participant "Orchestration\nService" as Orchestration
participant "Customer\nService" as Customer
participant "Security System\nService" as SecuritySystem
participant "Oso Integration\nService" as Oso
database "Kafka" as Kafka
database "Oso Cloud" as OsoCloud

User -> BFF: POST /api/securitysystems\n{locationId}
activate BFF

BFF -> Orchestration: POST /securitysystems\n{locationId}\n+ Bearer token
activate Orchestration

Orchestration -> Orchestration: Create CreateSecuritySystemSaga
Orchestration -> Kafka: ValidateLocationCommand\n{locationId}
Orchestration --> BFF: 202 Accepted\n{sagaId}
deactivate Orchestration

BFF --> User: Security system creation initiated
deactivate BFF

Kafka -> Customer: ValidateLocationCommand
activate Customer

Customer -> Customer: Look up Location by ID
Customer -> Kafka: LocationValidated\n{locationId, locationName, customerId}
deactivate Customer

Kafka -> Orchestration: LocationValidated
activate Orchestration

Orchestration -> Orchestration: Update saga state\n(locationName, customerId received)
Orchestration -> Kafka: CreateSecuritySystemCommand\n{locationId, locationName}
deactivate Orchestration

Kafka -> SecuritySystem: CreateSecuritySystemCommand
activate SecuritySystem

SecuritySystem -> SecuritySystem: Create SecuritySystem entity\n(state=DISARMED, locationId set)
SecuritySystem -> SecuritySystem: Persist to database\n(transactional outbox)
SecuritySystem -> Kafka: SecuritySystemAssignedToLocation event
SecuritySystem -> Kafka: SecuritySystemCreated\n{securitySystemId}
deactivate SecuritySystem

Kafka -> Orchestration: SecuritySystemCreated\n{securitySystemId}
activate Orchestration

Orchestration -> Orchestration: Mark saga as completed
deactivate Orchestration

' Event processing by Oso Integration Service
Kafka -> Oso: SecuritySystemAssignedToLocation event
activate Oso
Oso -> OsoCloud: Insert fact:\nhas_relation(SecuritySystem, "location", Location)
deactivate Oso

@enduml
....

=== Description

The sequence of events is:

. The User submits a request to create a security system via the BFF UI, providing the location ID.

. The BFF proxies the request to the Orchestration Service's `/securitysystems` endpoint, attaching the user's JWT bearer token for authentication.

. The Orchestration Service creates a new instance of the CreateSecuritySystemSaga and immediately returns a 202 Accepted response with the saga ID, allowing asynchronous processing.

. The BFF informs the user that security system creation has been initiated.

. The Orchestration Service sends a ValidateLocationCommand to the Customer Service via Kafka.

. The Customer Service receives the command, looks up the Location by ID, and returns a LocationValidated reply containing the `locationId`, `locationName`, and `customerId`.

. The Orchestration Service receives the reply, updates the saga state with the location details, and proceeds to the next step.

. The Orchestration Service sends a CreateSecuritySystemCommand to the Security System Service, including the `locationId` and `locationName`.

. The Security System Service receives the command, creates a new SecuritySystem entity in DISARMED state with the locationId reference, persists it to the database using the transactional outbox pattern, and publishes a SecuritySystemAssignedToLocation event to Kafka.

. The Security System Service sends a SecuritySystemCreated reply containing the `securitySystemId` back to the Orchestration Service.

. The Orchestration Service receives the reply and marks the saga as successfully completed.

. In parallel, the Oso Integration Service consumes the `SecuritySystemAssignedToLocation` event from Kafka.

. The Oso Integration Service inserts a `has_relation(SecuritySystem, "location", Location)` fact into Oso Cloud, linking the security system to its location.

. Authorization policies can now be enforced for the newly created security system based on location-based roles.

=== Failure Handling

==== Location Not Found

If the location does not exist:

. The Customer Service returns a LocationNotFound reply.
. The Orchestration Service marks the saga as failed.
. The controller returns a 404 Not Found response to the client.

==== Location Already Has Security System

If the location already has a security system (unique constraint violation):

. The Security System Service returns a LocationAlreadyHasSecuritySystem reply.
. The Orchestration Service marks the saga as failed.
. The controller returns a 409 Conflict response to the client.

=== Key Characteristics

* *Location-First Flow*: Location must exist before creating a security system
* *Asynchronous Processing*: The BFF returns immediately; saga execution happens in the background
* *Eventual Consistency*: All services eventually converge to a consistent state
* *Reliable Messaging*: Commands and events use Kafka with at-least-once delivery
* *No Compensation Needed*: Validation is read-only; creation failure doesn't require rollback
* *Distributed Tracing*: OpenTelemetry traces provide end-to-end visibility
* *Idempotency*: Services handle duplicate messages gracefully
* *Unique Constraint*: Each location can have at most one security system

