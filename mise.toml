[tools]
node = '22'
java = 'corretto-17'

[tasks.bff-test-all]
description = "Test the BFF"
depends = ["bff-unit-test"]
run = ["mise run bff-e2e-test"]

[tasks.bff-test-all-no-build]
description = "Test the BFF"
depends = ["bff-unit-test"]
run = ["COMPOSE_OPTS=--quiet-pull mise run bff-e2e-test"]

[tasks.e2e-test]
description = "Test the application"
depends = ["compose-up-and-wait"]
dir = "./realguardio-bff"
run = """
DISABLE_MOCK_BACKEND=yes npm run e2e-test
"""

[tasks.bff-unit-test]
dir = "./realguardio-bff"
run = "npm run unit-test"

[tasks.bff-e2e-test]
depends = ["iam-service-compose-up", "bff-dev-run", "security-system-service-compose-down"]
dir = "./realguardio-bff"
run = "npm run e2e-test"

[tasks.assemble]
description = "Assemble all realguardio services with Gradle"
run = """
for dir in realguardio-*/; do
  if [ -f "$dir/build.gradle" ]; then
    echo "Assembling $dir..."
    (cd "$dir" && ./gradlew assemble) || exit 1
  fi
done
"""

[tasks.compose-up]
depends = ["assemble", "bff-dev-stop"]
run = "DOCKERFILE_SUFFIX=-local docker compose up -d ${COMPOSE_OPTS:---build}"

[tasks.compose-down]
run = "docker compose down"

[tasks.compose-up-and-wait]
depends = ["compose-up"]
run = ["mise run wait-all"]

[tasks.wait-all]
depends = ["customer-service-wait", 
  "security-system-service-wait", 
  "orchestration-service-wait", 
  "bff-dev-wait", 
  "iam-service-wait"]


[tasks.bff-e2e-test-only]
dir = "./realguardio-bff"
run = "npm run e2e-test"

[tasks.iam-service-compose-up]
run = "DOCKERFILE_SUFFIX=-local docker compose up -d ${COMPOSE_OPTS:---build} realguardio-iam-service"

[tasks.iam-service-compose-build]
run = "DOCKERFILE_SUFFIX=-local docker compose build realguardio-iam-service"

[tasks.bff-compose-down]
run = "docker compose down realguardio-bff"

[tasks.security-system-service-compose-down]
run = "docker compose down realguardio-security-system-service"

[tasks.security-system-service-compose-up]
depends = ["assemble"]
run = "DOCKERFILE_SUFFIX=-local docker compose up -d ${COMPOSE_OPTS:---build} realguardio-security-system-service"

[tasks.e2e-test-only]
dir = "./realguardio-bff"
run = "DISABLE_MOCK_BACKEND=yes npm run e2e-test || DISABLE_MOCK_BACKEND=yes npm run e2e-test"

[tasks.bff-dev-wait]
run = "npx wait-on@8.0.3 --timeout 30s http://localhost:3000"

[tasks.iam-service-wait]
run = "npx wait-on@8.0.3 --timeout 10s http://localhost:9000/actuator/health"

[tasks.security-system-service-wait]
run = "npx wait-on@8.0.3 --timeout 40s http://localhost:3001/actuator/health"

[tasks.customer-service-wait]
run = "npx wait-on@8.0.3 --timeout 40s http://localhost:3002/actuator/health"

[tasks.orchestration-service-wait]
run = "npx wait-on@8.0.3 --timeout 40s http://localhost:3003/actuator/health"

[tasks.jaeger-restart]
run = ["docker compose down jaeger", 
    "docker compose up -d jaeger",
    "npx wait-on@8.0.3 --timeout 10s http://localhost:16686"]

[tasks.go]
run = """
mise compose-up
mise jaeger-restart
mise run e2e-test-only
echo
echo http://localhost:16686/dependencies
echo
echo "http://localhost:16686/search?operation=manual-span-check&service=realguardio-bff"
echo
"""

[tasks.go-local]
depends = ["iam-service-compose-up", "bff-dev-run"]
run = """
mise jaeger-restart
JWT_ISSUER_HOST=localhost mise security-system-service-compose-up
mise run e2e-test-only
echo
echo http://localhost:16686/dependencies
echo
echo "http://localhost:16686/search?operation=manual-span-check&service=realguardio-bff"
echo
"""

[tasks.node-version]
run = "node --version"

[tasks.java-version]
run = "java -version"

[tasks.bff-npm-install]
dir = "./realguardio-bff"
run = "npm install"

[tasks.build]
description = "Build all realguardio services with Gradle"
run = """
for dir in realguardio-*/; do
  if [ -f "$dir/build.gradle" ]; then
    echo "Building $dir..."
    (cd "$dir" && ./gradlew build) || exit 1
  fi
done
(cd end-to-end-tests; ./gradlew build) || exit 1
"""

[tasks.reset-db]
description = "Reset PostgreSQL database by recreating the container"
run = [
    "docker compose rm -f -s -v postgres",
    "docker compose up -d postgres",
    "npx wait-on@8.0.3 --timeout 10s tcp:5432"
]

[tasks.db-query-security-systems]
description = "Query all records from security_system table"
run = "docker compose exec postgres psql -U postgres -d securitysystem -c 'SELECT * FROM security_system;'"

[tasks.gh-download] 
run = "rm -fr _download && gh run download --dir _download -n logs -n test-reports -n compose-up-logs"

[tasks.backend-end-to-end-with-compose]
dir = "end-to-end-tests"
run = [
    "DOCKERFILE_SUFFIX=-local ./gradlew -P endToEndTestMode=DockerCompose clean build",
    "mise compose-down"
]

[tasks.gh-run-list]
run = "gh run list --limit=3"

[tasks.gh-run-watch]
run = "gh run watch $(gh run list --limit=1 --json databaseId --jq '.[0].databaseId')"
