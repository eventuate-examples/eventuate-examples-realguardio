== IAM Service

The IAM Service is the OAuth2 Authorization Server responsible for authentication and token issuance. It provides JWT-based authentication for all services in the RealGuardIO ecosystem.

=== Responsibilities

* Authenticate users via OAuth2/OIDC flows
* Issue JWT access tokens with user roles and claims
* Issue ID tokens for user profile information
* Provide JWKS (JSON Web Key Set) endpoint for token validation
* Manage OAuth2 client registrations
* Provide userinfo endpoint for authenticated user details
* Support OAuth2 authorization code flow with PKCE

=== Endpoints

==== OAuth2/OIDC Endpoints

* `GET/POST /oauth2/authorize` - OAuth2 authorization endpoint
** Initiates authorization code flow
** Requires user authentication
** Returns authorization code

* `POST /oauth2/token` - Token endpoint
** Exchanges authorization code for tokens
** Issues access token (JWT) and refresh token
** Requires client authentication

* `GET /oauth2/jwks` - JSON Web Key Set endpoint
** Provides public keys for JWT signature validation
** Used by resource servers to validate tokens
** No authentication required (public endpoint)

* `GET /userinfo` - OpenID Connect UserInfo endpoint
** Returns authenticated user's profile information
** Requires valid access token
** Returns: subject (sub), roles, and other claims

* `POST /oauth2/revoke` - Token revocation endpoint
** Revokes access or refresh tokens
** Requires client authentication

* `GET /.well-known/openid-configuration` - OIDC discovery endpoint
** Returns server metadata and endpoint URLs
** No authentication required (public endpoint)

=== Technology Stack

* *Framework*: Spring Boot 3.4.5
* *Authorization Server*: Spring Authorization Server
* *Security*: Spring Security
* *Language*: Java 17
* *Token Format*: JWT (JSON Web Tokens)
* *Signature Algorithm*: RS256 (RSA with SHA-256)

=== Security Configuration

==== Token Configuration

* *Access Token Format*: JWT
* *Token Lifetime*: Configurable (default: 2 minutes)
* *Refresh Token Lifetime*: Configurable (default: 60 minutes)
* *Token Claims*:
** `sub` - Subject (user identifier)
** `scope` - OAuth2 scopes
** `iss` - Issuer (IAM Service URL)
** `aud` - Audience
** `exp` - Expiration timestamp
** `iat` - Issued at timestamp
** Custom claims: User roles (REALGUARDIO_ADMIN, REALGUARDIO_CUSTOMER_EMPLOYEE)

==== Client Registration

Configured OAuth2 clients:
* *Client ID*: `realguardio-bff`
* *Client Secret*: Configured via environment variable
* *Grant Types*: authorization_code, refresh_token
* *Redirect URIs*: BFF callback URLs
* *Scopes*: openid, profile, email
* *PKCE*: Required for enhanced security

==== User Management

* Users are configured in application (can be extended to database)
* User roles define authorization levels:
** `REALGUARDIO_ADMIN` - System administrator role
** `REALGUARDIO_CUSTOMER_EMPLOYEE` - Customer employee role
* Passwords are stored using BCrypt hashing

=== Integration Points

==== Inbound

* *BFF*: OAuth2 client requesting tokens
* *Resource Servers*: Validate JWTs via JWKS endpoint
** Customer Service
** Security System Service
** Orchestration Service

==== Outbound

* None - IAM Service has no outbound dependencies on application services
* May integrate with external identity providers (LDAP, Active Directory, social login) in extended implementations

=== Deployment

* *Port*: 9000
* *Container Image*: Built using Docker multi-stage build
* *Environment Variables*:
** `SPRING_SECURITY_OAUTH2_AUTHORIZATIONSERVER_CLIENT_BFF_CLIENT_SECRET` - BFF client secret
** `SPRING_SECURITY_OAUTH2_AUTHORIZATIONSERVER_ISSUER` - Issuer URL (e.g., http://localhost:9000)
** User credentials configured via application properties or environment variables

=== Testing Strategy

* *Unit Tests*: Test token generation and validation logic
* *Integration Tests*: Test OAuth2 flows end-to-end
* *Security Tests*: Verify token security (expiration, signature validation)

=== Key Design Patterns

* *OAuth2 Authorization Code Flow* - Standard web application authentication
* *JWT (JSON Web Tokens)* - Stateless token format for distributed systems
* *JWKS (JSON Web Key Set)* - Public key distribution for token validation
* *PKCE (Proof Key for Code Exchange)* - Enhanced security for authorization code flow
